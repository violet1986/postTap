#!/usr/bin/env stap
// A long existing stap script to get plan node when a query start

function parse_plan:string (plan:long) {
    return sprintf("plantype:%d,plan:%p,plan_rows:%p,leftplan:%p,rightplan:%p", user_int(plan), plan, user_long(plan+24),user_long(plan+64), user_long(plan+72))
}


probe process("/usr/local/pgsql/bin/postgres").function("ExecInitNode").call
{
    plan = long_arg(1)
	printdln("|", pid(), ppfunc(), parse_plan(plan))
}

probe process("/usr/local/pgsql/bin/postgres").function("ExecutorStart").call   
{
    printdln("|", pid(), ppfunc())
}

probe process("/usr/local/pgsql/bin/postgres").function("ExecutorFinish").call 
{ 
    printdln("|", pid(), ppfunc())
}
probe process("/usr/local/pgsql/bin/postgres").function("CreateQueryDesc").call   
{
    printdln("|", pid(), ppfunc())
}
probe process("/usr/local/pgsql/bin/postgres").function("StatementCancelHandler").call   
{
    printdln("|", pid(), ppfunc())
}
