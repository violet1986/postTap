#!/usr/bin/env stap
function parse_planstate:string (planstate:long) {
    return sprintf("type:%d,addr:%p,plan:%p,left:%p,right:%p", kernel_int(planstate), planstate, kernel_long(planstate+8), kernel_long(planstate+56),kernel_long(planstate+64)) 
}

probe process("/usr/local/pgsql/bin/postgres").function("ExecutorStart").call   
{
    printdln("|", pid(), ppfunc())
}

probe process("/usr/local/pgsql/bin/postgres").function("ExecutorFinish").call 
{ 
    printdln("|", pid(), ppfunc())
}
probe process("/usr/local/pgsql/bin/postgres").function("CreateQueryDesc").call   
{
    printdln("|", pid(), ppfunc())
}
probe process("/usr/local/pgsql/bin/postgres").function("StatementCancelHandler").call   
{
    printdln("|", pid(), ppfunc())
}

probe process("/usr/local/pgsql/bin/postgres").function("ExecProcNode").call
{
    plan_state = long_arg(1)
    #filter seqscan
    if(kernel_int(plan_state) == 209) {
        return
    }
    printdln("|", pid(), ppfunc(), parse_planstate(plan_state))
}
